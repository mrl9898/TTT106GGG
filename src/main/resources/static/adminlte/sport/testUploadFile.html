<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>檔案上傳測試</title>
</head>
<body>
    <h2>上傳檔案</h2>
    <form id="uploadForm">
        <label>功能類型 (funcType):</label>
        <select name="funcType" id="uploadFuncType">
            <option value="sport">sport</option>
            <option value="customSport">customSport</option>
            <option value="sportType">sportType</option>
        </select>
        <br><br>
        <input type="file" name="file" id="uploadFileInput" />
        <br><br>
        <button type="button" onclick="uploadFile()">上傳</button>
    </form>

    <hr>

    <h2>刪除檔案</h2>
    <form id="deleteForm">
        <label>功能類型 (funcType):</label>
        <select name="funcType" id="deleteFuncType">
            <option value="sport">sport</option>
            <option value="customSport">customSport</option>
            <option value="sportType">sportType</option>
        </select>
        <br><br>
        <label>檔名:</label>
        <input type="text" id="deleteFileName" placeholder="例如 abc123.png" />
        <br><br>
        <button type="button" onclick="deleteFile()">刪除</button>
    </form>

    <hr>

    <h2>更新檔案</h2>
    <form id="updateForm">
        <label>功能類型 (funcType):</label>
        <select name="funcType" id="updateFuncType">
            <option value="sport">sport</option>
            <option value="customSport">customSport</option>
            <option value="sportType">sportType</option>
        </select>
        <br><br>
        <label>舊檔名:</label>
        <input type="text" id="oldFileName" placeholder="例如 abc123.png" />
        <br><br>
        <input type="file" id="newFile" />
        <br><br>
        <button type="button" onclick="updateFile()">更新</button>
    </form>

    <hr>

    <h2>查詢單一檔案 (getSingle)</h2>
    <form id="getSingleForm">
        <label>功能類型 (funcType):</label>
        <select name="funcType" id="getSingleFuncType">
            <option value="sport">sport</option>
            <option value="customSport">customSport</option>
            <option value="sportType">sportType</option>
        </select>
        <br><br>
        <label>檔名:</label>
        <input type="text" id="getSingleFileName" placeholder="例如 abc123.png" />
        <br><br>
        <button type="button" onclick="getSingle()">查詢單一檔案</button>
    </form>

    <hr>

    <h2>查詢多筆檔案 (getMultipleByFunc)</h2>
    <form id="getMultipleForm">
        <label>功能類型 (funcType):</label>
        <select name="funcType" id="getMultipleFuncType">
            <option value="sport">sport</option>
            <option value="customSport">customSport</option>
            <option value="sportType">sportType</option>
        </select>
        <br><br>
        <button type="button" onclick="getMultiple()">查詢多筆檔案</button>
    </form>

    <hr>

    <h2>結果</h2>
    <pre id="result"></pre>

    <script>
        async function callApi(url, options) {
            const resultEl = document.getElementById("result");

            // 顯示 Loading 狀態
            resultEl.textContent = "處理中，請稍候...";

            try {
                let res = await fetch(url, options);

                // 情況 A: HTTP 層級錯誤
                if (!res.ok) {
                    throw new Error("HTTP 錯誤狀態碼: " + res.status);
                }

                let data;
                try {
                    data = await res.json();
                } catch (parseErr) {
                    throw new Error("回傳內容非 JSON，API 壞掉了");
                }

                // 情況 B: API 回傳格式不完整
                if (!data || typeof data.returnCode === "undefined") {
                    resultEl.textContent =
                        "錯誤: API 回傳格式不正確，可能壞掉了\n" +
                        JSON.stringify(data, null, 2);
                    return;
                }

                // 情況 C: 正常判斷 returnCode
                if (data.returnCode !== "000") {
                    resultEl.textContent =
                        `錯誤: [${data.returnCode}] ${data.returnMsg}`;
                } else {
                    resultEl.textContent = JSON.stringify(data, null, 2);
                }

            } catch (err) {
                // 情況 D: 完全沒回應 or 其他例外
                resultEl.textContent = "系統錯誤: " + err.message;
            }
        }

        window.uploadFile = async function () {
            let formData = new FormData();
            formData.append("funcType", document.getElementById("uploadFuncType").value);
            formData.append("file", document.getElementById("uploadFileInput").files[0]);

            await callApi("/fileImg/api/upload", {
                method: "POST",
                body: formData
            });
        };

        window.deleteFile = async function () {
            let formData = new FormData();
            formData.append("funcType", document.getElementById("deleteFuncType").value);
            formData.append("fileName", document.getElementById("deleteFileName").value);

            await callApi("/fileImg/api/delete", {
                method: "POST",
                body: formData
            });
        };

        window.updateFile = async function () {
            let formData = new FormData();
            formData.append("funcType", document.getElementById("updateFuncType").value);
            formData.append("oldFileName", document.getElementById("oldFileName").value);

            if (document.getElementById("newFile").files.length > 0) {
                formData.append("newFile", document.getElementById("newFile").files[0]);
            }

            await callApi("/fileImg/api/update", {
                method: "POST",
                body: formData
            });
        };

        window.getSingle = async function () {
            let funcType = document.getElementById("getSingleFuncType").value;
            let fileName = document.getElementById("getSingleFileName").value;

            await callApi(
                `/fileImg/api/getSingle?funcType=${funcType}&fileName=${encodeURIComponent(fileName)}`,
                { method: "GET" }
            );
        };

        window.getMultiple = async function () {
            let funcType = document.getElementById("getMultipleFuncType").value;

            await callApi(
                `/fileImg/api/getMultipleByFunc?funcType=${funcType}`,
                { method: "GET" }
            );
        };
    </script>
</body>
</html>
